<h1>Tasks</h1>

<h2>Add New Task</h2>
<form id="new-task-form">
  <input type="text" name="name" placeholder="Name" required />
  <input type="text" name="description" placeholder="Description" required />
  <button type="submit">Add Task</button>
</form>

<h2>Tasks</h2>
<table border="1" cellpadding="5" cellspacing="0">
  <thead>
    <tr>
      <th>ID</th>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody id="tasks-table-body">
    {{#each tasks}}
    <tr data-id="{{id}}">
      <td>{{id}}</td>
      <td class="name">{{name}}</td>
      <td class="description">{{description}}</td>
      <td>
        <button class="edit-btn">Edit</button>
        <button class="delete-btn">Delete</button>
        <button class="save-btn" style="display:none;">Save</button>
        <button class="cancel-btn" style="display:none;">Cancel</button>
      </td>
    </tr>
    {{/each}}
  </tbody>
</table>

<script>
  async function fetchJSON(url, options) {
    const res = await fetch(url, options);
    if (!res.ok) throw new Error(await res.text());
    const contentType = res.headers.get('content-type') || '';
    if (contentType.includes('application/json')) {
      return res.json();
    }
    return null;
  }

  document.getElementById('new-task-form').addEventListener('submit', async e => {
    e.preventDefault();
    const form = e.target;
    const data = {
      name: form.name.value.trim(),
      description: form.description.value.trim(),
    };
    try {
      const newTask = await fetchJSON('/tasks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      appendTaskRow(newTask);
      form.reset();
    } catch (err) {
      alert('Error adding task: ' + err.message);
    }
  });

  function appendTaskRow(task) {
    const tbody = document.getElementById('tasks-table-body');
    const tr = document.createElement('tr');
    tr.dataset.id = task.id;
    tr.innerHTML = `
      <td>${task.id}</td>
      <td class="name">${task.name}</td>
      <td class="description">${task.description}</td>
      <td>
        <button class="edit-btn">Edit</button>
        <button class="delete-btn">Delete</button>
        <button class="save-btn" style="display:none;">Save</button>
        <button class="cancel-btn" style="display:none;">Cancel</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  document.getElementById('tasks-table-body').addEventListener('click', async e => {
    const tr = e.target.closest('tr');
    if (!tr) return;
    const id = tr.dataset.id;

    if (e.target.classList.contains('edit-btn')) {
      toggleEdit(tr, true);
    } else if (e.target.classList.contains('cancel-btn')) {
      toggleEdit(tr, false);
    } else if (e.target.classList.contains('save-btn')) {
      const updatedData = {
        name: tr.querySelector('input[name="name"]').value.trim(),
        description: tr.querySelector('input[name="description"]').value.trim(),
      };
      try {
        const updatedTask = await fetchJSON(`/tasks/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedData),
        });
        updateRow(tr, updatedTask);
        toggleEdit(tr, false);
      } catch (err) {
        alert('Error updating task: ' + err.message);
      }
    } else if (e.target.classList.contains('delete-btn')) {
      if (!confirm('Are you sure you want to delete this task?')) return;
      try {
        await fetchJSON(`/tasks/${id}`, { method: 'DELETE' });
        tr.remove();
      } catch (err) {
        alert('Error deleting task: ' + err.message);
      }
    }
  });

  function toggleEdit(tr, editing) {
    ['name', 'description'].forEach(field => {
      const td = tr.querySelector(`td.${field}`);
      if (editing) {
        const val = td.textContent;
        td.innerHTML = `<input name="${field}" value="${val}" />`;
      } else {
        const input = td.querySelector('input');
        if (input) td.textContent = input.value;
      }
    });
    tr.querySelector('.edit-btn').style.display = editing ? 'none' : 'inline-block';
    tr.querySelector('.delete-btn').style.display = editing ? 'none' : 'inline-block';
    tr.querySelector('.save-btn').style.display = editing ? 'inline-block' : 'none';
    tr.querySelector('.cancel-btn').style.display = editing ? 'inline-block' : 'none';
  }

  function updateRow(tr, task) {
    ['name', 'description'].forEach(field => {
      const td = tr.querySelector(`td.${field}`);
      td.textContent = task[field] || '';
    });
  }
</script>