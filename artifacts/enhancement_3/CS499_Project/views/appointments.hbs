<h1>Appointments</h1>

<h2>Add New Appointment</h2>
<form id="new-appointment-form">
  <input type="datetime-local" name="date" required />
  <input type="text" name="description" placeholder="Description" required />
  <button type="submit">Add Appointment</button>
</form>

<h2>Appointments</h2>
<table border="1" cellpadding="5" cellspacing="0">
  <thead>
    <tr>
      <th>ID</th>
      <th>Date</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody id="appointments-table-body">
    {{#each appointments}}
    <tr data-id="{{id}}">
      <td>{{id}}</td>
      <td class="date">{{date}}</td>
      <td class="description">{{description}}</td>
      <td>
        <button class="delete-btn">Delete</button>
      </td>
    </tr>
    {{/each}}
  </tbody>
</table>

<script>
  async function fetchJSON(url, options) {
    const res = await fetch(url, options);
    if (!res.ok) throw new Error(await res.text());
    const contentType = res.headers.get('content-type') || '';
    if (contentType.includes('application/json')) {
      return res.json();
    }
    return null;
  }

  document.getElementById('new-appointment-form').addEventListener('submit', async e => {
    e.preventDefault();
    const form = e.target;
    const data = {
      date: form.date.value.trim(),
      description: form.description.value.trim(),
    };
    try {
      const newAppointment = await fetchJSON('/appointments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      appendAppointmentRow(newAppointment);
      form.reset();
    } catch (err) {
      alert('Error adding appointment: ' + err.message);
    }
  });

  function appendAppointmentRow(appointment) {
    const tbody = document.getElementById('appointments-table-body');
    const tr = document.createElement('tr');
    tr.dataset.id = appointment.id;
    tr.innerHTML = `
      <td>${appointment.id}</td>
      <td class="date">${appointment.date}</td>
      <td class="description">${appointment.description}</td>
      <td>
        <button class="delete-btn">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  document.getElementById('appointments-table-body').addEventListener('click', async e => {
    const tr = e.target.closest('tr');
    if (!tr) return;
    const id = tr.dataset.id;

    if (e.target.classList.contains('edit-btn')) {
      toggleEdit(tr, true);
    } else if (e.target.classList.contains('cancel-btn')) {
      toggleEdit(tr, false);
    } else if (e.target.classList.contains('save-btn')) {
      const updatedData = {
        date: tr.querySelector('input[name="date"]').value.trim(),
        description: tr.querySelector('input[name="description"]').value.trim(),
      };
      try {
        const updatedAppointment = await fetchJSON(`/appointments/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedData),
        });
        updateRow(tr, updatedAppointment);
        toggleEdit(tr, false);
      } catch (err) {
        alert('Error updating appointment: ' + err.message);
      }
    } else if (e.target.classList.contains('delete-btn')) {
      if (!confirm('Are you sure you want to delete this appointment?')) return;
      try {
        await fetchJSON(`/appointments/${id}`, { method: 'DELETE' });
        tr.remove();
      } catch (err) {
        alert('Error deleting appointment: ' + err.message);
      }
    }
  });

  function toggleEdit(tr, editing) {
    ['date', 'description'].forEach(field => {
      const td = tr.querySelector(`td.${field}`);
      if (editing) {
        const val = td.textContent;
        td.innerHTML = `<input name="${field}" value="${val}" />`;
      } else {
        const input = td.querySelector('input');
        if (input) td.textContent = input.value;
      }
    });
    tr.querySelector('.delete-btn').style.display = editing ? 'none' : 'inline-block';
  }

  function updateRow(tr, appointment) {
    ['date', 'description'].forEach(field => {
      const td = tr.querySelector(`td.${field}`);
      td.textContent = appointment[field] || '';
    });
  }
</script>